$().ready(function () {
    //DISPLAY USER CONTACT INFO ON PAGE LOAD
    showAllUsers();

    function showAllUsers() {
        $.get("/api/users")
            .done(function (data) {
                data.forEach(function(result) {
                    //console log the result we got
                    console.log(result);
                    //I'm using string templates, not the + sign
                    //Am I okay?
                    var newCard = `<div class="card mx-2">
                    <div class="card-body">
                        <h5>${result.fullname}</h5>
                        <p><a href="mailto:${result.email}">Contact Them</a></p>
                    </div>
                    </div>`;  
                    //(cue ominous music)
                    $("#all-users").append(newCard);
                });
            })
            .fail(function (err) {
                //if we failed, there was an error ):
                alert("Sorry, an error occurred");
                console.log(err);
            });
    }

    //SIGN IN BUTTON FOR RETURNING USERS
    $(".btn-login").on("click", function () {
        event.preventDefault();
        //Grab the values from our form
        var formUsername = $("#username").val().trim();
        var formPassword = $("#password").val().trim();
        console.log(formPassword);
        //Make an object to send to the back end
        var returningUser = {
            username: formUsername,
            password: formPassword
        };

        $("#profile").empty();

        $.post("/login", returningUser)
            .done(function (data) {
                //if we succeeded then we GOT data!
                console.log(data);
                if (data.errno) {
                    $("#profile").append($("<p class='mt-3'>").text("Sorry, there was an error!"));
                    return;
                }
                //Let's append the data to our results area
                data.forEach(function (resultObj) {
                    console.log(resultObj)
                    var newCard = $("<div>").addClass("card");
                    var cardBody = $("<div>").addClass("card-body");
                    for (key in resultObj) {
                        var newData = $("<p>").addClass("card-text").text(key + ": " + resultObj[key]);
                        cardBody.append(newData);
                    }
                    newCard.append(cardBody);
                    $("#profile").append(newCard);
                });
            })
            .fail(function (err) {
                //if we failed, there was an error ):
                alert("Sorry, an error occurred");
                console.log(err);
            })
            .always(function () {
                //and regardless of whether we succeeded or failed:
                //always empty out the old form results ;)
                $(".form-group :input").each(function () {
                    $(this).val("");
                });
            });

    });

    //SIGN UP BUTTON FOR FIRST-TIME USERS
    $(".btn-signup").on("click", function () {
        event.preventDefault();
        //Make an object to send to the back end
        var newUser = {};

        //Grab the form items
        $(".form-group :input").each(function () {
            var currentInput = $(this); // This is the jquery object of the input, do what you will
            var nameOfField = currentInput.attr("id");
            var fieldValue = currentInput.val().trim();
            newUser[nameOfField] = fieldValue;
        });
        //Console log the user object
        console.log("============== New User! ================");
        console.log(newUser);

        //Submit the new user via ajax
        $.post("/api/users", newUser)
            .done(function (data) {
                //if we succeeded then we GOT data!
                console.log(data);
                location.replace("/newuser.html");
            })
            .fail(function (err) {
                //if we failed, there was an error ):
                alert("Sorry, an error occurred");
                console.log(err);
            })
            .always(function () {
                //and regardless of whether we succeeded or failed:
                //always empty out the old form results ;)
                $(".form-group :input").each(function () {
                    $(this).val("");
                });
            });

    });
});